<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Ứng dụng chia sẻ file</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <style>
    body { padding-top: 30px; }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">Chia sẻ file giữa 2 người dùng</h1>

  <h4>Máy đang kết nối:</h4>
  <ul id="clientList" class="list-group mb-4"></ul>

  <div class="form-group">
    <label for="fileInput">Chọn file cần gửi:</label>
    <input type="file" id="fileInput" class="form-control">
  </div>
  <button id="sendFile" class="btn btn-primary">Gửi file</button>

  <div class="mt-4">
    <h4>Tiến trình truyền file:</h4>
    <div class="progress">
      <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
    </div>
  </div>

  <div id="downloadLink" class="mt-4"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  const clientList = document.getElementById('clientList');

  // Cập nhật danh sách client và hiển thị thông tin trình duyệt, hệ điều hành
  socket.on('update-clients', (clients) => {
    clientList.innerHTML = '';
    clients.forEach(client => {
      let li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = `Client: ${client.id} | ${client.browser} | ${client.os} | Thiết bị: ${client.device}`;
      clientList.appendChild(li);
    });
  });

  const fileInput = document.getElementById('fileInput');
  const sendFileBtn = document.getElementById('sendFile');
  const progressBar = document.getElementById('progressBar');
  let fileReader;
  let file;
  let chunkSize = 64 * 1024; // 64KB
  let offset = 0;

  sendFileBtn.addEventListener('click', () => {
    if (fileInput.files.length === 0) return;
    file = fileInput.files[0];

    // Gửi metadata của file
    socket.emit('file-meta', {
      fileName: file.name,
      fileSize: file.size,
      fileType: file.type
    });

    offset = 0;
    readChunk();
  });

  function readChunk() {
    const slice = file.slice(offset, offset + chunkSize);
    fileReader = new FileReader();
    fileReader.onload = (e) => {
      console.log('Sending chunk from offset:', offset);
      socket.emit('file-chunk', { chunk: e.target.result, offset: offset });
      offset += e.target.result.byteLength;
      const percent = Math.min(100, Math.floor((offset / file.size) * 100));
      progressBar.style.width = percent + '%';
      progressBar.innerHTML = percent + '%';

      if (offset < file.size) {
        readChunk();
      }
    };
    fileReader.readAsArrayBuffer(slice);
  }

  let receivedFileMeta;
  let receivedChunks = [];
  let receivedSize = 0;

  socket.on('file-meta', (data) => {
    console.log('Received file-meta:', data);
    receivedFileMeta = data;
    receivedChunks = [];
    receivedSize = 0;
    progressBar.style.width = '0%';
    progressBar.innerHTML = '0%';
    document.getElementById('downloadLink').innerHTML = '';
  });

  socket.on('file-chunk', (data) => {
    console.log('Received file-chunk at offset:', data.offset);
    receivedChunks.push(data.chunk);
    receivedSize += data.chunk.byteLength;
    const percent = Math.min(100, Math.floor((receivedSize / receivedFileMeta.fileSize) * 100));
    progressBar.style.width = percent + '%';
    progressBar.innerHTML = percent + '%';

    if (receivedSize >= receivedFileMeta.fileSize) {
      const blob = new Blob(receivedChunks, { type: receivedFileMeta.fileType });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = receivedFileMeta.fileName;
      link.className = 'btn btn-success';
      link.innerHTML = 'Tải file: ' + receivedFileMeta.fileName;
      document.getElementById('downloadLink').appendChild(link);

      // Reset lại biến sau khi hoàn thành
      receivedFileMeta = null;
      receivedChunks = [];
      receivedSize = 0;
    }
  });
</script>
</body>
</html>
